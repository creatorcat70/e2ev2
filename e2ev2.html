<!DOCTYPE html>
<html lang="en">
    <head>
        <title>E2Ev2 (by cuhassle)</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <style>
            *{box-sizing: border-box; margin: 0;  background-color: #333; color:antiquewhite; font-family: 'Courier New', Courier, monospace;}
            html,body{height: 100%;}
            #load {z-index: 99; width:100%; height: 100%;}

            #navbar { height: 50px; width:100%; background-color: #222; display:flex; gap: 10px; position:fixed; padding:10px}
            button { cursor:pointer;border: none; border-radius: 50px; height:100%; padding-right: 10px; padding-left: 10px;}
            button:hover { border: antiquewhite 1px solid !important;}
            .navbar-div{display:flex;gap:10px;background-color: #222;}
            .right { display:flex;margin-left: auto;}
            #tabs {overflow-x: auto; overflow-y: hidden;}
            #tabs button {width:auto; display:flex; align-items: center;}

            main {height:auto;width: 100%;padding-top:60px;}

            .modal{display: none;position: fixed;z-index: 1; left: 0; right: 0; width: 100%; height: 100%; overflow: auto;  background-color: rgba(0,0,0,0.4); }
            .modal-content{margin:15% auto;padding: 20px;width: 80%;border: 1px solid #888; border-radius: 10px;}
            .modal input { border:none; background-color: #222; width: 100%;}
            .modal button { background-color: #222;}
            #newTabModal{display:block;}
            .close {float: right;font-size: 28px;font-weight: bold;}
            .close:hover,.close:focus {color: #aaa;text-decoration: none;cursor: pointer;}
        </style>
    </head>
    <body>
        <div id="load"><h1>Loding...</h1></div>

        <!--Settings Modal-->
        <div id="settingsModal" class="modal">
            <div class="modal-content">
                <span class="close" id="closeSettings" onclick="getElementById('settingsModal').style.display = 'none';">&times;</span>
                <h1>Settings</h1>
                <br>
            </div>
        </div>
        <!--Create New Tab Modal-->
        <div id="newTabModal" class="modal">
            <div class="modal-content">
                <span class="close" id="closeTabModal" onclick="closeModal()">&times;</span>
                <h1>Start New Chat</h1>
                <br>
                <p>Who are You Communicating With</p>
                <input id="name-input" placeholder="Enter What You'd Like to Call Them">
                <br><br>
                <p>Enter Their Public Key</p>
                <input id="key-input" placeholder="Put Somebody's Public Key Here"></input>
                <br><br>
                <button id="createChat" onclick="createNewTab()">Finish</button>
            </div>
        </div>
        <!--Navigation Bar-->
        <nav id="navbar">
            <div id="tabs" class="navbar-div"></div>   
            <button id="addTab" onclick="openTabModal()">+</button>
            <div class="right navbar-div">
                <button id="copyPublicKey" onclick="copyPublicKey()">Copy Your Public Key</button>
                <button id="settings" onclick="getElementById('settingsModal').style.display = 'block';">...</button>
            </div>
        </nav>
        <!--Main Section-->
        <main>
            <h1 id="mainTitle"></h1>
            <section></section>
        </main>
        <!--Javascript-->
        <script>
            // Class for each tab
            class tab {
                constructor(name, publicKey) {
                    this.name = name;
                    this.publicKey = publicKey;
                }
            }

            var tabs = [];
            var activetab;
            // Get the modal
            var modal = document.getElementById("newTabModal");
            var tabBar = document.getElementById("tabs");

            window.onload = generateKeys;
            var publicKey;
            var otherPublicKey;
            var privateKey;
            async function generateKeys(){
                const keyPair = await window.crypto.subtle.generateKey(
                    {
                        name: "ECDH",
                        namedCurve: "P-521",
                    },
                    true,
                    ["deriveKey"]
                );
                privateKey = keyPair.privateKey;
                publicKey = keyPair.publicKey;
                document.getElementById("load").style.display = "none";
            }

            function copyPublicKey() {
                var copyButton = document.getElementById("copyPublicKey");
                if (navigator.clipboard) {
                    navigator.clipboard.writeText(publicKey).then(() => {
                        copyButton.innerText = "Copied âœ…"
                        setTimeout(() => {
                            copyButton.innerText = "Copy Your Public Key"
                        }, 1500);
                    })
                }
            }

            function createNewTab() {
                var nameInput = document.getElementById("name-input");
                var keyInput = document.getElementById("key-input");
                if  (!keyInput.value) {
                    console.log("You need a key lol");
                    return;
                }
                if (!nameInput.value) {
                    nameInput.value = `Person ${tabs.length + 1}`;
                }
                tabs[tabs.length] = new tab(nameInput.value, keyInput.value);
                activetab=tabs.length-1;
                closeModal();
                
                var newTabButton = document.createElement("button");
                newTabButton.innerHTML = tabs[activetab].name + `<button onclick='closeTab(${activetab})'>&times;</button>`;
                const tabCounter = activetab;
                newTabButton.onclick = function(){openTab(tabCounter)};
                tabBar.appendChild(newTabButton);

                openTab(activetab);
                console.log("Created Tab");
            }

            function openTab(tab) {
                otherPublicKey = tabs[tab].publicKey;
                document.getElementById("mainTitle").innerText = `Communicate Secretly with ${tabs[tab].name}`;
            }



            //Open Menu
            function openTabModal() {
                modal.style.display = "block";
            }
            function closeModal() {
                modal.style.display = "none";
                document.getElementById("name-input").value = null;
                document.getElementById("key-input").value = null;
            }
            

            // Closing Page bad because need to create new keys and add all chats back (Thanks internet)

            window.addEventListener("beforeunload", function (e) {
                var confirmationMessage = 'CLOSING THIS TAB COULD HAVE UNINTENDED CONSEQUENCES! '
                                        + 'If you leave, your chats and private key will be lost.';

                (e || window.event).returnValue = confirmationMessage; //Gecko + IE
                return confirmationMessage; //Gecko + Webkit, Safari, Chrome etc.
            });
        </script>
    </body>
</html>